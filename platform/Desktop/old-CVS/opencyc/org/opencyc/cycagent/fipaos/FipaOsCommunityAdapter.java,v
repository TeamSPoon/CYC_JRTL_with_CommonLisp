head	1.11;
access;
symbols
	PRE_1_0:1.11;
locks; strict;
comment	@# @;


1.11
date	2002.01.23.17.16.35;	author stephenreed;	state Exp;
branches;
next	1.10;

1.10
date	2001.12.05.03.47.59;	author stephenreed;	state Exp;
branches;
next	1.9;

1.9
date	2001.12.05.01.48.10;	author stephenreed;	state Exp;
branches;
next	1.8;

1.8
date	2001.12.03.02.51.37;	author stephenreed;	state Exp;
branches;
next	1.7;

1.7
date	2001.12.02.23.32.01;	author stephenreed;	state Exp;
branches;
next	1.6;

1.6
date	2001.11.30.07.25.21;	author stephenreed;	state Exp;
branches;
next	1.5;

1.5
date	2001.11.29.08.10.48;	author stephenreed;	state Exp;
branches;
next	1.4;

1.4
date	2001.11.19.21.55.33;	author stephenreed;	state Exp;
branches;
next	1.3;

1.3
date	2001.11.14.01.15.17;	author stephenreed;	state Exp;
branches;
next	1.2;

1.2
date	2001.11.12.03.56.49;	author stephenreed;	state Exp;
branches;
next	1.1;

1.1
date	2001.11.09.22.09.34;	author stephenreed;	state Exp;
branches;
next	;


desc
@@


1.11
log
@Made the org.opencyc.cycagent.coabs package optional, as the required CoABS grid
classes are not open source, nor freely downloadable.  The FIPA-OS package is
open source and OpenCyc can be configured to work with it alone.
@
text
@package org.opencyc.cycagent.fipaos;

import java.io.IOException;
import java.util.*;
import javax.naming.TimeLimitExceededException;
import fipaos.ont.fipa.*;
import fipaos.ont.fipa.fipaman.*;
import fipaos.agent.*;
import fipaos.agent.task.*;
import fipaos.platform.ams.AMSRegistrationException;
import fipaos.platform.df.DFRegistrationException;
import fipaos.util.DIAGNOSTICS;
import fipaos.agent.conversation.*;
import org.opencyc.cycagent.*;
import org.opencyc.util.*;

/**
 * Provides the interface for interacting with the FIPA-OS agent community.<p>
 *
 * @@version $Id: FipaOsCommunityAdapter.java,v 1.10 2001/12/05 03:47:59 stephenreed Exp $
 * @@author Stephen L. Reed
 *
 * <p>Copyright 2001 Cycorp, Inc., license is open source GNU LGPL.
 * <p><a href="http://www.opencyc.org/license.txt">the license</a>
 * <p><a href="http://www.opencyc.org">www.opencyc.org</a>
 * <p><a href="http://www.sourceforge.net/projects/opencyc">OpenCyc at SourceForge</a>
 * <p>
 * THIS SOFTWARE AND KNOWLEDGE BASE CONTENT ARE PROVIDED ``AS IS'' AND
 * ANY EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
 * PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OPENCYC
 * ORGANIZATION OR ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
 * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
 * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE AND KNOWLEDGE
 * BASE CONTENT, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

public class FipaOsCommunityAdapter extends FIPAOSAgent implements AgentCommunityAdapter {

    /**
     * outbound message serial number.
     */
    public int msgSerialNumber = 0;

    /**
     * Sets verbosity of this object's output.  0 --> quiet ... 9 -> maximum
     * diagnostic input.
     */
    protected int verbosity = DEFAULT_VERBOSITY;

    /**
     * reference to the name of my agent
     */
    protected String myAgentName;

    /**
     * The parent agent object which implements the MessageReceiver interface.
     */
    protected MessageReceiver messageReceiver;

    /**
     * the platform profile location
     */
    public static String platform_profile = "e:\\fipa-os\\profiles\\platform.profile";

    /**
     * the FIPA-OS agent owner
     */
    public static final String OWNER = "OpenCyc";

    /**
     * the FIPA-OS diagnostic level
     */
    protected int diagnosticLevel = DIAGNOSTICS.LEVEL_MAX;

    /**
     * Implements an association:  message id --> waiting thread for the reply.
     */
    protected Hashtable waitingReplyThreads = new Hashtable();

    /**
     * Implements an association:  message id --> reply message acl.
     */
    protected Hashtable replyMessages = new Hashtable();


    /**
     * Indicates whether this agent is registered.
     */
    protected boolean isRegistered = false;

    /**
     * Constructs a new FipaOsCommunityAdapter object for the given agent, with the given verbosity.
     *
     * @@param verbosity the verbosity of this agent adapter's output.  0 --> quiet ... 9 -> maximum
     * diagnostic input
     */
    public FipaOsCommunityAdapter(MessageReceiver messageReceiver, int verbosity) {
        super(platform_profile,
              messageReceiver.getMyAgentName(),
              FipaOsCommunityAdapter.OWNER,
              true);
        this.messageReceiver = messageReceiver;
        if (Log.current == null)
            Log.makeLog();
        if (verbosity > 2)
            Log.current.println("messageReceiver " + messageReceiver);
        myAgentName = messageReceiver.getMyAgentName();
        this.verbosity = verbosity;
        if (verbosity == 0)
            diagnosticLevel = DIAGNOSTICS.LEVEL_MIN;
        else if (verbosity < 2)
            diagnosticLevel = DIAGNOSTICS.LEVEL_2;
        else if (verbosity < 5)
            diagnosticLevel = DIAGNOSTICS.LEVEL_3;
        else if (verbosity < 9)
            diagnosticLevel = DIAGNOSTICS.LEVEL_4;
        else
            diagnosticLevel = DIAGNOSTICS.LEVEL_MAX;
        register();
        if (verbosity > 2)
            Log.current.println("My agent ID\n  " + this.getAID());
        Runtime.getRuntime().addShutdownHook(new Shutdown());
    }

    /**
     * Not used in the FipaOsCommunityAdapter.
     *
     * @@param messageReceiver the parent application which can receive agent messages via a callback
     * @@param verbosity the verbosity of this agent adapter's output.  0 --> quiet ... 9 -> maximum
     * diagnostic input
     */
    public void initialize (MessageReceiver messageReceiver, int verbosity) throws IOException {
    }

    /**
     * Registers the agent on the FIPA-OS agent community.
     */
    protected void register() {
        if (verbosity > 0)
            Log.current.println("Starting FipaOsCommunityAdapter for " + myAgentName);
        setListenerTask(new IdleTask());
        try {
            registerWithAMS();
            DIAGNOSTICS.println("Registered with AMS", this, diagnosticLevel);
        }
        catch (AMSRegistrationException amsre) {
            DIAGNOSTICS.println(amsre, this, diagnosticLevel);
            String reason = amsre.getExceptionReason();
            if (reason == null ||
                ! reason.equals(FIPAMANCONSTANTS.AGENT_ALREADY_REGISTERED)) {
                shutdown();
                return;
            }
            DIAGNOSTICS.println("Already registered with AMS", this, diagnosticLevel);
        }
        try {
            if (verbosity > 2)
                Log.current.print("Registering with DF for type " +
                                  messageReceiver.getAgentType());
            registerWithDF(messageReceiver.getAgentType());
            DIAGNOSTICS.println("Registered with DF", this, diagnosticLevel);
        }
        catch (DFRegistrationException dfre) {
            DIAGNOSTICS.println(dfre, this, diagnosticLevel);
            String reason = dfre.getExceptionReason();
            if (reason == null ||
                ! reason.equals(FIPAMANCONSTANTS.AGENT_ALREADY_REGISTERED)) {
                shutdown();
                return;
            }
            DIAGNOSTICS.println("Already registered with DF", this, diagnosticLevel);
        }
        isRegistered = true;
    }


    /**
     * Sends an Agent Communication Language message.
     *
     * @@param acl the Agent Communication Language message to be sent
     */
    public void sendMessage (ACL acl) {
        if (acl.getPerformative().equals(FIPACONSTANTS.INFORM)) {
            String inReplyTo = acl.getInReplyTo();
            Thread waitingForReply = (Thread) this.waitingReplyThreads.get(inReplyTo);
            if (waitingForReply != null) {
                replyMessages.put(inReplyTo, acl);
                waitingForReply.interrupt();
                return;
            }
        }
        forward(acl);
    }

    public static final long WAIT_FOREVER = Long.MAX_VALUE;

    /**
     * Sends an Agent Communication Language message and returns the reply.
     *
     * @@param acl the Agent Communication Language message to be sent
     * @@param timer a Timer object contolling the maximum wait time for a reply message,
     * after which an excecption is thrown.
     * @@return the Agent Communication Language reply message which has been received for my agent
     *
     * @@thows TimeLimitExceededException when the time limit is exceeded before a reply message
     * is received.
     */
    public ACL converseMessage (ACL acl, org.opencyc.util.Timer timer)
        throws TimeLimitExceededException, IOException {
        ACL replyAcl = null;
        Object result = null;
        if (verbosity > 2)
            Log.current.println("converseMessage sending\n" + acl);
        try {
            long remainingMilliSeconds = timer.getRemainingMilliSeconds();
            // Handle different timer behavior between org.opencyc.util.Timer and FIPA-OS.
            if (remainingMilliSeconds >
                (Long.MAX_VALUE / 1024))
                remainingMilliSeconds = Long.MAX_VALUE / 1024;
            result =
                SynchronousTask.executeTask(_tm,
                                            new RequestTask(acl),
                                            remainingMilliSeconds);
            if (verbosity > 2)
                Log.current.println("result:\n" + result);

        }
        catch( Throwable t) {
            DIAGNOSTICS.println( "Exception when starting a Task",
                                t, diagnosticLevel);
        }
        if (result instanceof SynchronousTask.TimeoutResult)
            throw new TimeLimitExceededException();
        else
            replyAcl = (ACL) result;
        return replyAcl;
    }

    /**
     * Returns the next message serial number identifier.
     *
     * @@return the next message serial number identifier
     */
    public String nextMessageId () {
        return "message" + ++msgSerialNumber;
    }

    /**
     * De-register this agent.
     */
    public void deregister() {
        if (! isRegistered)
            return;
        try {
            deregisterWithDF();
        }
        catch (DFRegistrationException e) {
            DIAGNOSTICS.println(e, this, diagnosticLevel);
            shutdown();
            return;
        }
        try {
            deregisterWithAMS();
        }
        catch (AMSRegistrationException e) {
            DIAGNOSTICS.println(e, this, diagnosticLevel);
            shutdown();
            return;
        }
        isRegistered = false;
    }

    /**
     * Terminate this agent.
     */
    public void terminate() {
        shutdown();
        return;
    }

    /**
     * Sets verbosity of this object's output.  0 --> quiet ... 9 -> maximum
     * diagnostic input.
     *
     * @@param verbosity 0 --> quiet ... 9 -> maximum diagnostic input
     */
    public void setVerbosity(int verbosity) {
        this.verbosity = verbosity;
        if (verbosity == 0)
            diagnosticLevel = DIAGNOSTICS.LEVEL_MIN;
        else if (verbosity < 2)
            diagnosticLevel = DIAGNOSTICS.LEVEL_2;
        else if (verbosity < 5)
            diagnosticLevel = DIAGNOSTICS.LEVEL_3;
        else if (verbosity < 9)
            diagnosticLevel = DIAGNOSTICS.LEVEL_4;
        else
            diagnosticLevel = DIAGNOSTICS.LEVEL_MAX;
    }

    /**
     * Returns a string representation of this object.
     *
     * @@param a string representation of this object
     */
    public String toString() {
        return "[" + this.getClass() + " named " + this.myAgentName + "]";
    }

    /**
     * Provides an idle task which handles incomming messages which are not
     * otherwise associated with an in-progress conversation.
     */
    public class IdleTask extends Task {

        /**
         * Constructs a new IdleTask object.
         */
        public IdleTask() {
        }

        /**
         * Starts the IdleTask task.
         */
        protected void startTask() {
            DIAGNOSTICS.println("Started IdleTask", diagnosticLevel);
        }

        /**
         * Handles a new conversation whose first message is a request performative.
         *
         * @@param conv the Request conversation
         */
        public void handleRequest(Conversation conv) {
            DIAGNOSTICS.println( "Received request", diagnosticLevel);
            if (conv.getProtocol().equals(FIPACONSTANTS.FIPA_REQUEST))
                newTask(new AgreeInformTask(conv), conv);
            else
                DIAGNOSTICS.println( "Ignored request", diagnosticLevel);
        }

        /**
         * Handles completion of an AgreePerform task.
         */
        public void doneFipaOsCommunityAdapter_AgreeInformTask(Task task) {
            DIAGNOSTICS.println("Completed AgreeInform task\n" + task, diagnosticLevel);
        }
    }

    /**
     * Provides for the initiation and handling of a fipa-request conversation.  This task
     * is involked via a SynchronousTask wrapper and the result is returned via the done
     * method.
     */
    public class RequestTask extends Task {
        /**
         * the request message sent to the specified receiver.
         */
        ACL requestAcl;

        /**
         * The inform message received as the reply.
         */
        ACL replyAcl;

        /**
         * Constructs a new RequestTask object given the request ACL.
         *
         * @@param requestAcl the request message Agent Communication Language
         */
        public RequestTask (ACL requestAcl) {
            this.requestAcl = requestAcl;
            if (verbosity > 2)
                Log.current.print("\nconstructed RequestTask for\n" + requestAcl);
        }

        /**
         * Starts this task and initiates the fipa-request conversation.  The conversation
         * manager will assign a conversationID to the requestAcl object and create a new
         * fipa-request conversation to track it.
         */
        protected void startTask() {
            if (verbosity > 2)
                Log.current.print("\nstarting RequestTask and sending\n" + requestAcl);
            forward(requestAcl);
            DIAGNOSTICS.println("Sent request to " + requestAcl.getReceiverAID().getName(),
                                diagnosticLevel);
        }

        /**
         * Handle the request message which is part of the fipa-request conversation by doing
         * nothing.
         */
        public void handleRequest(Conversation fipaRequest) {
            if (verbosity > 2)
                Log.current.println("\nhandling Request " + fipaRequest);
        }

        /**
         * Handle the inform message which is part of the fipa-request conversation by doing
         * nothing.
         */
        public void handleAgree(Conversation fipaRequest) {
            if (verbosity > 2)
                Log.current.println("\nhandling Agree " + fipaRequest);
        }

        /**
         * Handle the inform message which is part of the RequestProtocol.  The replyAcl
         * is returned via the done method.
         */
        public void handleInform(Conversation fipaRequest) {
            if (verbosity > 2)
                Log.current.println("\nhandling Inform " + fipaRequest);
            replyAcl = fipaRequest.getACL(fipaRequest.getLatestMessageIndex());
            done(replyAcl);
        }
    }

    /**
     * Provides for handling the reply to the request message of a
     * fipa-request conversation.
     */
    public class AgreeInformTask extends Task {
        /**
         * Conversation within which we are replying.
         */
        private Conversation fipaRequest;

        /**
         * Constructs a new AgreeInformTask task given the conversation.
         *
         * @@param fipaRequest conversation within which we are replying
         */
        public AgreeInformTask (Conversation fipaRequest) {
            this.fipaRequest = fipaRequest;
        }

        /**
         * Starts this task, sends the agree, and  sends the reply.
         */
        protected void startTask() {
            if (verbosity > 0)
                Log.current.println("\n\nAgreeInformTask responding to fipaRequest\n" +
                                    fipaRequest);
            ACL requestAcl =
                fipaRequest.getACL(fipaRequest.getLatestMessageIndex());
            ACL agreeAcl = (ACL) requestAcl.clone();
            agreeAcl.setPerformative(FIPACONSTANTS.AGREE);
            agreeAcl.setSenderAID(getAID());
            agreeAcl.setReceiverAID(requestAcl.getSenderAID());
            if (verbosity > 0)
                Log.current.println("\nSending agree acl\n" + agreeAcl);
            forward(agreeAcl);
            waitingReplyThreads.put(requestAcl.getReplyWith(), Thread.currentThread());
            messageReceiver.messageReceived(AgentCommunityAdapter.FIPA_OS_AGENT_COMMUNITY,
                                            requestAcl);
            while (true)
                try {
                    Thread.sleep(1000);
                }
                catch (InterruptedException e) {
                    break;
                }
            ACL replyAcl = (ACL) replyMessages.get(requestAcl.getReplyWith());
            replyAcl.setSenderAID(getAID());
            if (verbosity > 0)
                Log.current.println("\nSending inform acl\n" + replyAcl);
            forward(replyAcl);
            done();
        }
    }

    /**
     * Thread which shuts down the agent nicely.
     */
    protected class Shutdown extends Thread {
        /**
         * Constructs a new Shutdown object.
         */
        public Shutdown () {
        }

        /**
         * Runs the shutdown thread.
         */
        public void run () {
            System.out.println("Shutting down");
            deregister();
            shutdown();
        }
    }
}@


1.10
log
@Continued FIPA-OS Cyc-API testing
@
text
@d20 1
a20 1
 * @@version $Id: FipaOsCommunityAdapter.java,v 1.9 2001/12/05 01:48:10 stephenreed Exp $
d128 10
@


1.9
log
@Continued testing FIPA-OS
@
text
@d20 1
a20 1
 * @@version $Id: FipaOsCommunityAdapter.java,v 1.8 2001/12/03 02:51:37 stephenreed Exp $
d182 1
a182 1
                this.replyMessages.put(inReplyTo, acl);
d210 5
d218 1
a218 1
                                            timer.getRemainingMilliSeconds());
d461 3
@


1.8
log
@Continued testing FIPA-OS code
@
text
@d20 1
a20 1
 * @@version $Id: FipaOsCommunityAdapter.java,v 1.7 2001/12/02 23:32:01 stephenreed Exp $
d433 3
d440 1
a440 1
            agreeAcl.setSenderAID(requestAcl.getReceiverAID());
d442 2
@


1.7
log
@Continued testing FIPA-OS agent integration
@
text
@d20 1
a20 1
 * @@version $Id: FipaOsCommunityAdapter.java,v 1.6 2001/11/30 07:25:21 stephenreed Exp $
d90 6
d103 4
a106 1
        super(platform_profile, messageReceiver.getMyAgentName(), FipaOsCommunityAdapter.OWNER, true);
d127 1
d166 1
d168 1
d242 2
d260 1
d453 20
@


1.6
log
@Coding FIPA-OS support
@
text
@d20 1
a20 1
 * @@version $Id: FipaOsCommunityAdapter.java,v 1.5 2001/11/29 08:10:48 stephenreed Exp $
d68 1
a68 1
    public static String platform_profile = "g:\\fipa-os\\profiles\\platform.profile";
d98 5
a114 2
        if (Log.current == null)
            Log.makeLog();
d116 2
d139 1
d142 3
d195 2
d199 5
a203 3
                (ACL) SynchronousTask.executeTask(_tm,
                                                  new RequestTask(acl),
                                                  timer.getRemainingMilliSeconds());
d277 9
d316 7
d348 2
d358 2
d366 9
d379 2
d384 1
a384 1
         * Handle the inform message which is part of the RequestInformProtocol.  The replyAcl
d387 4
a390 2
        public void handleInform(Conversation requestInformProtocol) {
            replyAcl = requestInformProtocol.getACL(requestInformProtocol.getLatestMessageIndex());
@


1.5
log
@Added FIPA-OS agent code
@
text
@d20 1
a20 1
 * @@version $Id: FipaOsCommunityAdapter.java,v 1.4 2001/11/19 21:55:33 stephenreed Exp $
d71 5
d97 1
a97 1
        super(platform_profile, messageReceiver.getMyAgentName(), "OpenCyc", true);
@


1.4
log
@Initial check in.
@
text
@d4 1
d7 7
d20 1
a20 1
 * @@version $Id: FipaOsCommunityAdapter.java,v 1.3 2001/11/14 01:15:17 stephenreed Exp $
d42 1
a42 1
public class FipaOsCommunityAdapter implements AgentCommunityAdapter {
d63 21
a83 1
    MessageReceiver messageReceiver;
d92 1
d95 10
d107 1
d111 36
d152 10
d177 1
a177 1
    public ACL converseMessage (ACL acl, Timer timer)
d179 18
a196 1
        return acl;
d212 16
d234 2
d246 142
@


1.3
log
@Completed first round of CoABS agent tests with the OpenCyc api
@
text
@d7 1
a7 1
import org.opencyc.util.Timer;
d12 1
a12 1
 * @@version $Id: FipaOsCommunityAdapter.java,v 1.2 2001/11/12 03:56:49 stephenreed Exp $
d42 1
a42 1
     * The default verbosity of the solution output.  0 --> quiet ... 9 -> maximum
d45 1
a45 1
    public static final int DEFAULT_VERBOSITY = 3;
d48 1
a48 1
     * name of my agent
d50 1
a50 1
    protected String agentName;
d53 1
a53 1
     * Constructs a new FipaOsCommunityAdapter object given my agent's name.
d55 1
a55 3
    public FipaOsCommunityAdapter(String agentName) {
        this.agentName = agentName;
    }
d58 1
a58 1
     * Sends an Agent Communication Language message.
d60 2
a61 1
     * @@param acl the Agent Communication Language message to be sent
d63 5
a67 1
    public void sendMessage (ACL acl) {
d71 1
a71 1
     * Notifies my agent that an Agent Communication Language message has been received.
d73 1
a73 1
     * @@param acl the Agent Communication Language message which has been received for my agent
d75 1
a75 1
    public void messageReceived (ACL acl) {
d115 10
@


1.2
log
@Added methods to agent communication classes
@
text
@d7 1
d12 1
a12 1
 * @@version $Id: FipaOsCommunityAdapter.java,v 1.1 2001/11/09 22:09:34 stephenreed Exp $
d81 2
a82 2
     * @@param timeoutMilliseconds the maximum wait time for a reply message, after which an
     * excecption is thrown.
d88 1
a88 1
    public ACL converseMessage (ACL acl, long timeoutMilliseconds)
d100 6
@


1.1
log
@Initial check in
@
text
@d11 1
a11 1
 * @@version $Id: CycConnectionInterface.java,v 1.1 2001/11/09 02:50:59 stephenreed Exp $
d101 5
@

